<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>60HN: CRE burden at admission and discharge</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="analysis_files/libs/clipboard/clipboard.min.js"></script>
<script src="analysis_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="analysis_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="analysis_files/libs/quarto-html/popper.min.js"></script>
<script src="analysis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="analysis_files/libs/quarto-html/anchor.min.js"></script>
<link href="analysis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="analysis_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="analysis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="analysis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="analysis_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#constants" id="toc-constants" class="nav-link active" data-scroll-target="#constants"><span class="header-section-number">1</span> Constants</a></li>
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages"><span class="header-section-number">2</span> Packages</a></li>
  <li><a href="#general-functions" id="toc-general-functions" class="nav-link" data-scroll-target="#general-functions"><span class="header-section-number">3</span> General functions</a></li>
  <li><a href="#discharge-dates" id="toc-discharge-dates" class="nav-link" data-scroll-target="#discharge-dates"><span class="header-section-number">4</span> Discharge dates</a></li>
  <li><a href="#crf-data" id="toc-crf-data" class="nav-link" data-scroll-target="#crf-data"><span class="header-section-number">5</span> CRF data</a>
  <ul>
  <li><a href="#sec-samples_dates" id="toc-sec-samples_dates" class="nav-link" data-scroll-target="#sec-samples_dates"><span class="header-section-number">5.1</span> Samples dates</a></li>
  <li><a href="#sec-wards" id="toc-sec-wards" class="nav-link" data-scroll-target="#sec-wards"><span class="header-section-number">5.2</span> Wards</a></li>
  <li><a href="#enrolled" id="toc-enrolled" class="nav-link" data-scroll-target="#enrolled"><span class="header-section-number">5.3</span> Enrolled</a></li>
  <li><a href="#durations" id="toc-durations" class="nav-link" data-scroll-target="#durations"><span class="header-section-number">5.4</span> Durations</a></li>
  </ul></li>
  <li><a href="#sec-malditof_data" id="toc-sec-malditof_data" class="nav-link" data-scroll-target="#sec-malditof_data"><span class="header-section-number">6</span> MALDI-TOF data</a></li>
  <li><a href="#cre-exposure" id="toc-cre-exposure" class="nav-link" data-scroll-target="#cre-exposure"><span class="header-section-number">7</span> CRE exposure</a>
  <ul>
  <li><a href="#sec-proportion_CRE" id="toc-sec-proportion_CRE" class="nav-link" data-scroll-target="#sec-proportion_CRE"><span class="header-section-number">7.1</span> All CRE</a></li>
  <li><a href="#k.-pneumoniae" id="toc-k.-pneumoniae" class="nav-link" data-scroll-target="#k.-pneumoniae"><span class="header-section-number">7.2</span> <em>K. pneumoniae</em></a></li>
  </ul></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">8</span> Data preparation</a>
  <ul>
  <li><a href="#minimum-data" id="toc-minimum-data" class="nav-link" data-scroll-target="#minimum-data"><span class="header-section-number">8.1</span> Minimum data</a></li>
  <li><a href="#covariates" id="toc-covariates" class="nav-link" data-scroll-target="#covariates"><span class="header-section-number">8.2</span> Covariates</a></li>
  </ul></li>
  <li><a href="#k.-pneumoniae-1" id="toc-k.-pneumoniae-1" class="nav-link" data-scroll-target="#k.-pneumoniae-1"><span class="header-section-number">9</span> <em>K. pneumoniae</em></a>
  <ul>
  <li><a href="#preparing-the-data" id="toc-preparing-the-data" class="nav-link" data-scroll-target="#preparing-the-data"><span class="header-section-number">9.1</span> Preparing the data</a></li>
  <li><a href="#multi-state-modelling" id="toc-multi-state-modelling" class="nav-link" data-scroll-target="#multi-state-modelling"><span class="header-section-number">9.2</span> Multi-state modelling</a>
  <ul class="collapse">
  <li><a href="#basic-operations" id="toc-basic-operations" class="nav-link" data-scroll-target="#basic-operations"><span class="header-section-number">9.2.1</span> Basic operations</a></li>
  <li><a href="#bootstrapped-cis" id="toc-bootstrapped-cis" class="nav-link" data-scroll-target="#bootstrapped-cis"><span class="header-section-number">9.2.2</span> Bootstrapped CIs</a></li>
  <li><a href="#covariates-1" id="toc-covariates-1" class="nav-link" data-scroll-target="#covariates-1"><span class="header-section-number">9.2.3</span> Covariates</a></li>
  <li><a href="#diagnostics" id="toc-diagnostics" class="nav-link" data-scroll-target="#diagnostics"><span class="header-section-number">9.2.4</span> Diagnostics</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#pipeline" id="toc-pipeline" class="nav-link" data-scroll-target="#pipeline"><span class="header-section-number">10</span> Pipeline</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">60HN: CRE burden at admission and discharge</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="constants" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="constants"><span class="header-section-number">1</span> Constants</h2>
<p>The folder that contains the data files:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>path2data <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"/Users/"</span>, <span class="fu">Sys.getenv</span>(<span class="st">"USER"</span>), <span class="st">"/Library/CloudStorage/"</span>,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"OneDrive-OxfordUniversityClinicalResearchUnit/"</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"GitHub/choisy/60HN/"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The name of the file that contains the discharge dates of the patients that did not provide samples at discharge:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>discharge_file <span class="ot">&lt;-</span> <span class="st">"60HN - DischargeDate_no_discharge_sample_27Nov25.xlsx"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The name of the CRF data file:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>CRF_file <span class="ot">&lt;-</span> <span class="st">"25-11-2025-_60HN_PATIENT_P1_Data.xls"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The name of the MALDI-TOF data file:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>MALDITOF_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"60HN_LAB_ID_20251014_merged_Blue and"</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                        <span class="st">" pink_confirmed by Maldi-TOF.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Number of minutes per day:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mpd <span class="ot">&lt;-</span> <span class="dv">1440</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The number of cores to use for parallel computing:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> <span class="dv">11</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="packages" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="packages"><span class="header-section-number">2</span> Packages</h2>
<p>Required packages:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>required <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"readxl"</span>, <span class="st">"purrr"</span>, <span class="st">"dplyr"</span>, <span class="st">"lubridate"</span>, <span class="st">"magrittr"</span>, <span class="st">"tidyr"</span>, <span class="st">"msm"</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>              <span class="st">"rlang"</span>, <span class="st">"mgcv"</span>, <span class="st">"gratia"</span>, <span class="st">"alluvial"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Installing those that are not installed yet:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>to_install <span class="ot">&lt;-</span> required[<span class="sc">!</span> required <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="st">"Package"</span>]]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(to_install)) <span class="fu">install.packages</span>(to_install)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Loading the packages for interactive use:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">sapply</span>(required, library, <span class="at">character.only =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="general-functions" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="general-functions"><span class="header-section-number">3</span> General functions</h2>
<p>A function that pastes a vector of dates and a vector of times both in character format and returns a <code>dttm</code> vector:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>as_datetime2 <span class="ot">&lt;-</span> <span class="cf">function</span>(date, time) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  as_datetime2_ <span class="ot">&lt;-</span> <span class="cf">function</span>(date, time) {</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(date)) <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(time)) time <span class="ot">&lt;-</span> <span class="st">"12:00:00"</span>    <span class="co"># if only time is missing, we fix it to noon</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_datetime</span>(<span class="fu">paste</span>(date, time))</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map2_vec</span>(date, time, as_datetime2_)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A function that converts a column <code>col</code> of a data frame <code>x</code> into a list-column (assuming that all the other columns have the same values across rows):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>col2listcol <span class="ot">&lt;-</span> <span class="cf">function</span>(x, col) {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span> {{ col }}) <span class="sc">|&gt;</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#    head(1) |&gt; </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">first</span>() <span class="sc">|&gt;</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="fu">tibble</span>(<span class="st">"{{col}}"</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">list</span>(<span class="fu">pull</span>(x, {{ col }}))))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A tuning of the <code>hist()</code> function:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>hist2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) <span class="fu">hist</span>(x, <span class="fu">floor</span>(<span class="fu">min</span>(x))<span class="sc">:</span><span class="fu">ceiling</span>(<span class="fu">max</span>(x)), <span class="at">main =</span> <span class="cn">NA</span>, ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A wrapper that formats the output of the <code>binom.test()</code> function:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>binom_test <span class="ot">&lt;-</span> <span class="cf">function</span>(x, n, ...) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n <span class="sc">&lt;</span> <span class="dv">1</span>) <span class="fu">return</span>(<span class="fu">c</span>(<span class="at">estimate =</span> <span class="cn">NA</span>, <span class="at">lower =</span> <span class="cn">NA</span>, <span class="at">upper =</span> <span class="cn">NA</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">binom.test</span>(x, n, ...) <span class="sc">|&gt;</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    magrittr<span class="sc">::</span><span class="fu">extract</span>(<span class="fu">c</span>(<span class="st">"estimate"</span>, <span class="st">"conf.int"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>() <span class="sc">|&gt;</span> </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">"estimate"</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A tuning of the <code>polygon()</code> function:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>polygon2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y1, y2, <span class="at">border =</span> <span class="cn">NA</span>, ...) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">polygon</span>(<span class="fu">c</span>(x, <span class="fu">rev</span>(x)), <span class="fu">c</span>(y1, <span class="fu">rev</span>(y2)), <span class="at">border =</span> border, ...)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Utility functions to convert coordinates to make a stairs plot style:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>x_transform <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">c</span>(x[<span class="dv">1</span>], <span class="fu">rep</span>(x[<span class="sc">-</span><span class="dv">1</span>], <span class="at">each =</span> <span class="dv">2</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>y_transform <span class="ot">&lt;-</span> <span class="cf">function</span>(y) <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">head</span>(y, <span class="sc">-</span><span class="dv">1</span>), <span class="at">each =</span> <span class="dv">2</span>), <span class="fu">last</span>(y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A function that returns the indexes of the first values of consecutive NAs of a vector:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>firstNA <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(x))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span> <span class="fu">diff</span>(y) <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(z)) <span class="fu">return</span>(y[<span class="sc">-</span>(<span class="fu">which</span>(z) <span class="sc">+</span> <span class="dv">1</span>)])</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Example use:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">firstNA</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">3</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="cn">NA</span>, <span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">6</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  6 11 16</code></pre>
</div>
</div>
<p>A function that duplicates the first rows of a series of rows with NA values in the <code>colNA</code> column, and replaces the values of the <code>col_sel</code> columns with values of the row right before:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>duplicate_NA_rows <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">colNA =</span> <span class="st">"estimate"</span>,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">col_sel =</span> <span class="fu">c</span>(<span class="st">"denominator"</span>, <span class="st">"numerator"</span>, <span class="st">"estimate"</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"lower"</span>, <span class="st">"upper"</span>)) {</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">mutate</span>(x, <span class="at">.id =</span> <span class="fu">row_number</span>())</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  NA_ind <span class="ot">&lt;-</span> <span class="fu">firstNA</span>(x[[colNA]])</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  duplicates <span class="ot">&lt;-</span> x[NA_ind, ]</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  duplicates[, col_sel] <span class="ot">&lt;-</span> x[NA_ind <span class="sc">-</span> <span class="dv">1</span>, col_sel]</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  duplicates <span class="sc">|&gt;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(x) <span class="sc">|&gt;</span> </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(.id) <span class="sc">|&gt;</span> </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>.id)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A function that splits a data frame <code>x</code> into a list of data frames according to the presence of missing values in the <code>col</code> column of the data frame:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>remove_NAs <span class="ot">&lt;-</span> <span class="cf">function</span>(x, col) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">|&gt;</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">col1 =</span> <span class="fu">as.numeric</span>(<span class="fu">is.na</span>({{ col }})),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">col2 =</span> <span class="fu">cumsum</span>(col1)) <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.exclude</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(col2) <span class="sc">|&gt;</span> </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_split</span>()</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Example use:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># carbs &lt;- mtcars$carb</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># carbs[c(8, 20:25)] &lt;- NA</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># mtcars$carb &lt;- carbs</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># remove_NAs(mtcars, carb)</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># rm(mtcars)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A tuning of the <code>msm()</code> function for a bi-state bi-directional case:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>bsm <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, subject, data, ...) {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">do.call</span>(msm<span class="sc">::</span>msm, <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">formula =</span> formula,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">subject =</span> <span class="fu">substitute</span>(subject),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">data    =</span> data,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">qmatrix =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">0</span>), <span class="dv">2</span>)), <span class="fu">list</span>(...)))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>call <span class="ot">&lt;-</span> <span class="fu">match.call</span>()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  output</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A function that bootstraps estimates of the fitted multistate model <code>msm_fit</code> where <code>f</code> is the function that generates the estimates and <code>N</code> is the number of bootstrap repetitions:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>boot_msm <span class="ot">&lt;-</span> <span class="cf">function</span>(msm_fit, <span class="at">f =</span> qmatrix.msm, <span class="at">N =</span> <span class="dv">1000</span>, ...) {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  msm_fit <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">boot.msm</span>(<span class="cf">function</span>(x) <span class="fu">f</span>(x)<span class="sc">$</span>estimates, N, ...) <span class="sc">|&gt;</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>() <span class="sc">|&gt;</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">array</span>(<span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">dim</span>(msm_fit<span class="sc">$</span>Qmatrices<span class="sc">$</span>baseline), N))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A function that generates statistic <code>f</code> estimates from bootstrap samples <code>boot_samples</code> outputed by <code>boot_msm()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>boot_stat <span class="ot">&lt;-</span> <span class="cf">function</span>(boots_samples, <span class="at">f =</span> sd) {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">apply</span>(boots_samples, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, f)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  mat_names <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"State"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(output))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(output) <span class="ot">&lt;-</span>  mat_names</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(output) <span class="ot">&lt;-</span>  mat_names</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  output</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A function that generates a <code>ci</code>% confidence interval from bootstrap samples <code>boot_samples</code> outputed by <code>boot_msm()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>boot_ci <span class="ot">&lt;-</span> <span class="cf">function</span>(boots_samples, <span class="at">ci =</span> .<span class="dv">95</span>) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  ci <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> ci) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">apply</span>(boots_samples, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fu">c</span>(ci, <span class="dv">1</span> <span class="sc">-</span> ci)))</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  mat_names <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"State"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(output))</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dimnames</span>(output) <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">rownames</span>(output[, , <span class="dv">1</span>]), mat_names, mat_names)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aperm</span>(output, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>))</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A function that computes <code>lubridate</code>-formatted durations:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>time_diff <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">as.duration</span>(<span class="fu">diff</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A function that extracts the estimations with 95% CI of the rate of colonization and decolonization per 100 patient days:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>bsm_estimations <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">event_names =</span> <span class="fu">c</span>(<span class="st">"colonization"</span>, <span class="st">"clearance"</span>)) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">matrix</span>(x<span class="sc">$</span>estimates.t, <span class="dv">2</span>), x<span class="sc">$</span>ci)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(out) <span class="ot">&lt;-</span> event_names</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(out) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"estimate"</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">100</span> <span class="sc">*</span> out</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A tuning of the <code>alluvial()</code> function:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>alluvial2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">print =</span> <span class="cn">TRUE</span>, ...) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">alluvial</span>(x[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">freq =</span> x[[<span class="dv">3</span>]], ...)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (print) <span class="fu">return</span>(x)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="discharge-dates" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="discharge-dates"><span class="header-section-number">4</span> Discharge dates</h2>
<p>Loading the discharge dates for the patients who did not provide any sample at discharge:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>(discharge_dates <span class="ot">&lt;-</span> <span class="fu">paste0</span>(path2data, discharge_file) <span class="sc">|&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">read_excel</span>() <span class="sc">|&gt;</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="st">`</span><span class="at">Discharge date</span><span class="st">`</span>, <span class="sc">~</span> .x <span class="sc">+</span> <span class="fu">hours</span>(<span class="dv">12</span>))) <span class="sc">|&gt;</span>  <span class="co"># setting time to noon</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(<span class="sc">-</span>No, <span class="sc">-</span>SiteID, <span class="sc">-</span><span class="st">`</span><span class="at">Discharge date (2)</span><span class="st">`</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 96 × 2
   USUBJID    `Discharge date`   
   &lt;chr&gt;      &lt;dttm&gt;             
 1 010-3-1-05 2025-02-23 12:00:00
 2 010-1-1-10 2025-02-24 12:00:00
 3 010-1-1-22 2025-02-25 12:00:00
 4 010-1-1-26 2025-02-28 12:00:00
 5 010-2-1-09 2025-03-06 12:00:00
 6 010-2-1-22 2025-03-06 12:00:00
 7 010-3-1-09 2025-03-06 12:00:00
 8 010-3-1-39 2025-03-23 12:00:00
 9 010-3-1-36 2025-03-17 12:00:00
10 010-3-1-42 2025-03-25 12:00:00
# ℹ 86 more rows</code></pre>
</div>
</div>
</section>
<section id="crf-data" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="crf-data"><span class="header-section-number">5</span> CRF data</h2>
<p>Reading the data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(path2data, CRF_file)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>sheets <span class="ot">&lt;-</span> file <span class="sc">|&gt;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">excel_sheets</span>() <span class="sc">|&gt;</span> </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>CRF <span class="ot">&lt;-</span> sheets <span class="sc">|&gt;</span> </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(read_excel, <span class="at">path =</span> file) <span class="sc">|&gt;</span> </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(sheets) <span class="sc">|&gt;</span> </span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span> .x <span class="sc">|&gt;</span>  <span class="co"># de-duplication of records</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(USUBJID) <span class="sc">|&gt;</span> </span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_modify</span>(<span class="sc">~</span> .x <span class="sc">|&gt;</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">arrange</span>(<span class="fu">desc</span>(entry)) <span class="sc">|&gt;</span> </span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">first</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>          <span class="fu">ungroup</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="sec-samples_dates" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="sec-samples_dates"><span class="header-section-number">5.1</span> Samples dates</h3>
<p>The dates of samples collection at admission and discharge:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> CRF <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract2</span>(<span class="st">"SCR"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(USUBJID, SPEC_DATE_ADMISSION, SPEC_TIME_ADMISSION,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                  SPEC_DATE_DISCHARGE, SPEC_TIME_DISCHARGE) <span class="sc">|&gt;</span> </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ADMISSION =</span> <span class="fu">as_datetime2</span>(SPEC_DATE_ADMISSION, SPEC_TIME_ADMISSION),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">DISCHARGE =</span> <span class="fu">as_datetime2</span>(SPEC_DATE_DISCHARGE, SPEC_TIME_DISCHARGE)) <span class="sc">|&gt;</span> </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span> SPEC_DATE_ADMISSION, <span class="sc">-</span> SPEC_TIME_ADMISSION,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span> SPEC_DATE_DISCHARGE, <span class="sc">-</span> SPEC_TIME_DISCHARGE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which gives:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>dates</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,000 × 3
   USUBJID    ADMISSION           DISCHARGE          
   &lt;chr&gt;      &lt;dttm&gt;              &lt;dttm&gt;             
 1 008-1-1-01 2025-03-11 16:30:00 2025-03-13 14:40:00
 2 008-1-1-02 2025-03-12 10:00:00 2025-03-14 10:00:00
 3 008-1-1-03 2025-03-12 09:50:00 2025-03-14 09:50:00
 4 008-1-1-04 2025-03-12 13:45:00 2025-03-13 14:55:00
 5 008-1-1-05 2025-03-12 13:40:00 2025-03-28 17:00:00
 6 008-1-1-06 2025-03-12 12:30:00 2025-03-20 14:25:00
 7 008-1-1-07 2025-03-12 14:40:00 2025-03-14 10:30:00
 8 008-1-1-08 2025-03-12 14:30:00 2025-03-17 10:10:00
 9 008-1-1-09 2025-03-12 14:50:00 2025-03-14 09:40:00
10 008-1-1-10 2025-03-12 15:10:00 2025-03-17 14:40:00
# ℹ 1,990 more rows</code></pre>
</div>
</div>
<p>The number of missing samples at discharge:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>(nb_missing_samples <span class="ot">&lt;-</span> dates <span class="sc">|&gt;</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(<span class="fu">is.na</span>(DISCHARGE)) <span class="sc">|&gt;</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">nrow</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 96</code></pre>
</div>
</div>
<p>The number of samples at admission is:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>(nb_samples_admission <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dates))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2000</code></pre>
</div>
</div>
<p>The number of samples at discharge is:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>(nb_samples_discharge <span class="ot">&lt;-</span> nb_samples_admission <span class="sc">-</span> nb_missing_samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1904</code></pre>
</div>
</div>
<p>The total number of samples is:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>(nb_samples <span class="ot">&lt;-</span> nb_samples_admission <span class="sc">+</span> nb_samples_discharge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3904</code></pre>
</div>
</div>
<p>Verifying that <code>DISCHARGE</code> is after <code>ADMISSION</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>dates <span class="sc">|&gt;</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.exclude</span>() <span class="sc">|&gt;</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DISCHARGE <span class="sc">&lt;</span> ADMISSION)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 3
# ℹ 3 variables: USUBJID &lt;chr&gt;, ADMISSION &lt;dttm&gt;, DISCHARGE &lt;dttm&gt;</code></pre>
</div>
</div>
</section>
<section id="sec-wards" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="sec-wards"><span class="header-section-number">5.2</span> Wards</h3>
<blockquote class="blockquote">
<p>From Huong:</p>
<p>“I just realize that there is one significant factor that would significantly contribute the force of infection (colonization) during hospitalization. This is the fact that patients from the same clinical ward can transmit CRE between one another. Therefore it would be best if the model can include the possibility within-ward transmission versus between within-hospital transmission. The ward type variable can identify the patients in the same ward or not. I think this should be the first priority to add.”</p>
</blockquote>
<p>Generating the ward data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>(wards <span class="ot">&lt;-</span> CRF<span class="sc">$</span>ADM <span class="sc">|&gt;</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"WARD"</span>), as.numeric),</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">ward =</span> <span class="fu">paste0</span>(SITEID, WARD_1, WARD_2, WARD_3)) <span class="sc">|&gt;</span> </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(SITEID) <span class="sc">|&gt;</span> </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(USUBJID, ward))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,000 × 2
   USUBJID    ward  
   &lt;chr&gt;      &lt;chr&gt; 
 1 008-1-1-01 008100
 2 008-1-1-02 008100
 3 008-1-1-03 008100
 4 008-1-1-04 008100
 5 008-1-1-05 008100
 6 008-1-1-06 008100
 7 008-1-1-07 008100
 8 008-1-1-08 008100
 9 008-1-1-09 008100
10 008-1-1-10 008100
# ℹ 1,990 more rows</code></pre>
</div>
</div>
<p>An overview of the number of patients per wards:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>nb_wards <span class="ot">&lt;-</span> wards <span class="sc">|&gt;</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ward) <span class="sc">|&gt;</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>()</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>nb_wards <span class="sc">|&gt;</span> </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 31 × 2
   ward       n
   &lt;chr&gt;  &lt;int&gt;
 1 010100   157
 2 071110   120
 3 073110   115
 4 130100   110
 5 159100   103
 6 008100   102
 7 156100    90
 8 158001    89
 9 160110    89
10 161100    89
11 159001    83
12 155110    81
13 157110    79
14 157001    70
15 155001    69
16 159010    64
17 158100    61
18 161001    61
19 010001    47
20 010010    46
21 130001    40
22 156010    40
23 160001    37
24 073001    35
25 008001    32
26 071001    25
27 160100    24
28 156001    20
29 008010    16
30 071100     5
31 157100     1</code></pre>
</div>
</div>
</section>
<section id="enrolled" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="enrolled"><span class="header-section-number">5.3</span> Enrolled</h3>
<p>A function that computes the data for ward occupancy:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>ward_occupancy <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="cf">function</span>(...) <span class="fu">pivot_longer</span>(..., <span class="at">names_to =</span> <span class="st">"change"</span>, <span class="at">values_to =</span> <span class="st">"date"</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">f</span>(<span class="fu">select</span>(x, <span class="sc">-</span>DISCHARGE), ADMISSION),</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">f</span>(<span class="fu">select</span>(x, <span class="sc">-</span>ADMISSION), DISCHARGE)) <span class="sc">|&gt;</span> </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(date) <span class="sc">|&gt;</span> </span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(change, <span class="sc">~</span> <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>), <span class="fu">c</span>(<span class="st">"ADMISSION"</span>, <span class="st">"DISCHARGE"</span>))[.x])) <span class="sc">|&gt;</span> </span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span> </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">change =</span> <span class="fu">sum</span>(change)) <span class="sc">|&gt;</span> </span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">occupancy =</span> <span class="fu">cumsum</span>(change)) <span class="sc">|&gt;</span> </span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>change)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A function that plots a ward occupancy:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>plot_occ <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">y =</span> <span class="cn">NULL</span>, ...) {</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">|&gt;</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">first</span>() <span class="sc">|&gt;</span> </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">occupancy =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(x) <span class="sc">|&gt;</span> </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">with</span>({</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(date, occupancy, <span class="at">type =</span> <span class="st">"n"</span>, ...)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">polygon</span>(<span class="fu">c</span>(<span class="fu">head</span>(date, <span class="dv">2</span>), <span class="fu">rep</span>(<span class="fu">tail</span>(date, <span class="sc">-</span><span class="dv">2</span>), <span class="at">each =</span> <span class="dv">2</span>)),</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>              <span class="fu">c</span>(<span class="fu">first</span>(occupancy),</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>                <span class="fu">rep</span>(<span class="fu">tail</span>(<span class="fu">head</span>(occupancy, <span class="sc">-</span><span class="dv">1</span>), <span class="sc">-</span><span class="dv">1</span>), <span class="at">each =</span> <span class="dv">2</span>),</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">last</span>(occupancy)), <span class="at">col =</span> <span class="st">"grey"</span>)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span> <span class="fu">is.null</span>(y)) <span class="fu">abline</span>(<span class="at">v =</span> y, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where <code>x</code> is an output from <code>ward_occupancy()</code> and <code>y</code> is the date of the last admission of the ward. Putting the ward and dates data together, using <code>discharge_dates</code> for patients who did not provide any sample at discharge (for the latter, the time is set to noon and, for those who have admission and discharge the same day with admission in the afternoon, discharge time is then set to one hour after admission):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>(ward_dates <span class="ot">&lt;-</span> wards <span class="sc">|&gt;</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(dates, <span class="st">"USUBJID"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(discharge_dates, <span class="st">"USUBJID"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="fu">across</span>(DISCHARGE, <span class="sc">~</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(.x), <span class="st">`</span><span class="at">Discharge date</span><span class="st">`</span>, .x)),</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>          <span class="fu">across</span>(DISCHARGE, <span class="sc">~</span> <span class="fu">if_else</span>(<span class="fu">as_date</span>(DISCHARGE) <span class="sc">==</span> <span class="fu">as_date</span>(ADMISSION) <span class="sc">&amp;</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>                                        DISCHARGE <span class="sc">&lt;</span> ADMISSION,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>                                      ADMISSION <span class="sc">+</span> <span class="fu">hours</span>(<span class="dv">1</span>), DISCHARGE))) <span class="sc">|&gt;</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(<span class="sc">-</span> <span class="st">`</span><span class="at">Discharge date</span><span class="st">`</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,000 × 4
   USUBJID    ward   ADMISSION           DISCHARGE          
   &lt;chr&gt;      &lt;chr&gt;  &lt;dttm&gt;              &lt;dttm&gt;             
 1 008-1-1-01 008100 2025-03-11 16:30:00 2025-03-13 14:40:00
 2 008-1-1-02 008100 2025-03-12 10:00:00 2025-03-14 10:00:00
 3 008-1-1-03 008100 2025-03-12 09:50:00 2025-03-14 09:50:00
 4 008-1-1-04 008100 2025-03-12 13:45:00 2025-03-13 14:55:00
 5 008-1-1-05 008100 2025-03-12 13:40:00 2025-03-28 17:00:00
 6 008-1-1-06 008100 2025-03-12 12:30:00 2025-03-20 14:25:00
 7 008-1-1-07 008100 2025-03-12 14:40:00 2025-03-14 10:30:00
 8 008-1-1-08 008100 2025-03-12 14:30:00 2025-03-17 10:10:00
 9 008-1-1-09 008100 2025-03-12 14:50:00 2025-03-14 09:40:00
10 008-1-1-10 008100 2025-03-12 15:10:00 2025-03-17 14:40:00
# ℹ 1,990 more rows</code></pre>
</div>
</div>
<p>Verifying that <code>DISCHARGE</code> is after <code>ADMISSION</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>ward_dates <span class="sc">|&gt;</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.exclude</span>() <span class="sc">|&gt;</span> </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DISCHARGE <span class="sc">&lt;</span> ADMISSION)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 4
# ℹ 4 variables: USUBJID &lt;chr&gt;, ward &lt;chr&gt;, ADMISSION &lt;dttm&gt;, DISCHARGE &lt;dttm&gt;</code></pre>
</div>
</div>
<p>Computing the dates of last admissions for each ward:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>last_admissions <span class="ot">&lt;-</span> ward_dates <span class="sc">|&gt;</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>DISCHARGE) <span class="sc">|&gt;</span> </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.exclude</span>() <span class="sc">|&gt;</span> </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ward) <span class="sc">|&gt;</span> </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span> .x <span class="sc">|&gt;</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">arrange</span>(ADMISSION) <span class="sc">|&gt;</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">last</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ADMISSION)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Computing and plotting the ward occupancies:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>opar <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>ward_dates <span class="sc">|&gt;</span> </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ward) <span class="sc">|&gt;</span> </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_map</span>(<span class="sc">~</span> <span class="fu">ward_occupancy</span>(.x), <span class="at">.keep =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">walk2</span>(last_admissions, plot_occ, <span class="at">ann =</span> <span class="cn">FALSE</span>)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(opar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-occupancies" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-occupancies-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analysis_files/figure-html/fig-occupancies-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="796">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-occupancies-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Number of patients enrolled as a function of time for each ward. The red vertical line indicates the last enrollment.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="durations" class="level3" data-number="5.4">
<h3 data-number="5.4" class="anchored" data-anchor-id="durations"><span class="header-section-number">5.4</span> Durations</h3>
<p>The distribution of the durations of stay in the wards:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>ward_dates <span class="sc">|&gt;</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">duration =</span> <span class="fu">as.numeric</span>(DISCHARGE <span class="sc">-</span> ADMISSION) <span class="sc">/</span> mpd) <span class="sc">|&gt;</span> </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(duration) <span class="sc">|&gt;</span> </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hist2</span>(<span class="at">xlab =</span> <span class="st">"duration of stay (days)"</span>, <span class="at">ylab =</span> <span class="st">"number of patients"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-durations_distribution" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-durations_distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analysis_files/figure-html/fig-durations_distribution-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="537">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-durations_distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: The distribution of the time spent in the ward.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Let’s see whether there any trend on the duration of stay across wards:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>the_data <span class="ot">&lt;-</span> ward_dates <span class="sc">|&gt;</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">duration =</span> <span class="fu">as.numeric</span>(DISCHARGE <span class="sc">-</span> ADMISSION) <span class="sc">/</span> mpd) <span class="sc">|&gt;</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(nb_wards, <span class="st">"ward"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n, duration)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>the_model <span class="ot">&lt;-</span> <span class="fu">gam</span>(duration <span class="sc">~</span> <span class="fu">s</span>(n), Gamma, the_data, <span class="at">method =</span> <span class="st">"REML"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fitted_values</span>(<span class="fu">tibble</span>(<span class="at">n =</span> <span class="fu">seq</span>(<span class="fu">min</span>(the_data<span class="sc">$</span>n), <span class="fu">max</span>(the_data<span class="sc">$</span>n), <span class="at">le =</span> <span class="dv">512</span>)))</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(the_data, <span class="fu">plot</span>(<span class="fu">jitter</span>(n, <span class="dv">5</span>), duration, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"black"</span>, .<span class="dv">1</span>), <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">xlab =</span> <span class="st">"number of patients enrolled"</span>,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ylab =</span> <span class="st">"duration of stay (days)"</span>))</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>color_model <span class="ot">&lt;-</span> <span class="st">"steelblue"</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(the_model, {</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">polygon2</span>(n, .lower_ci, .upper_ci, <span class="at">col =</span> <span class="fu">adjustcolor</span>(color_model, .<span class="dv">3</span>))</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(n, .fitted, <span class="at">col =</span> color_model)</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-durations_nb_patients" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-durations_nb_patients-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analysis_files/figure-html/fig-durations_nb_patients-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="537">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-durations_nb_patients-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: The duration of stay as a function of the number of patients enrolled across the wards.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-malditof_data" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="sec-malditof_data"><span class="header-section-number">6</span> MALDI-TOF data</h2>
<p>Reading the MALDI-TOF data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>unidentified <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"No organism identification possible"</span>, </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"No peaks found"</span>, <span class="st">"no peaks found"</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>(MALDITOF <span class="ot">&lt;-</span> path2data <span class="sc">|&gt;</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(MALDITOF_file) <span class="sc">|&gt;</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_excel</span>() <span class="sc">|&gt;</span> </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(USUBJID, SampleSchedule, Identification_MALDITOF) <span class="sc">|&gt;</span> </span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">|&gt;</span> </span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(Identification_MALDITOF,</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span> <span class="fu">if_else</span>(.x <span class="sc">%in%</span> unidentified, <span class="st">"unidentified"</span>, .x))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,210 × 3
   USUBJID    SampleSchedule Identification_MALDITOF
   &lt;chr&gt;      &lt;chr&gt;          &lt;chr&gt;                  
 1 010-1-1-01 ADMISSION      Klebsiella pneumoniae  
 2 160-1-1-09 ADMISSION      Enterobacter hormaechei
 3 160-2-1-06 ADMISSION      Klebsiella pneumoniae  
 4 160-2-1-04 ADMISSION      Enterobacter hormaechei
 5 160-2-1-04 DISCHARGE      Enterobacter hormaechei
 6 010-1-1-06 DISCHARGE      Enterobacter cloacae   
 7 010-1-1-01 DISCHARGE      Klebsiella pneumoniae  
 8 010-1-1-14 ADMISSION      Enterococcus faecium   
 9 010-1-1-14 ADMISSION      Klebsiella aerogenes   
10 160-2-1-06 DISCHARGE      Klebsiella pneumoniae  
# ℹ 1,200 more rows</code></pre>
</div>
</div>
<p>Number of isolates not identified and identified:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>MALDITOF <span class="sc">|&gt;</span> </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">identification =</span> Identification_MALDITOF <span class="sc">!=</span> <span class="st">"unidentified"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(identification) <span class="sc">|&gt;</span> </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  identification     n
  &lt;lgl&gt;          &lt;int&gt;
1 FALSE             26
2 TRUE            1184</code></pre>
</div>
</div>
<p>The list of positive samples:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>(MALDITOF_samples <span class="ot">&lt;-</span> MALDITOF <span class="sc">|&gt;</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(<span class="sc">-</span> Identification_MALDITOF) <span class="sc">|&gt;</span> </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">unique</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,055 × 2
   USUBJID    SampleSchedule
   &lt;chr&gt;      &lt;chr&gt;         
 1 010-1-1-01 ADMISSION     
 2 160-1-1-09 ADMISSION     
 3 160-2-1-06 ADMISSION     
 4 160-2-1-04 ADMISSION     
 5 160-2-1-04 DISCHARGE     
 6 010-1-1-06 DISCHARGE     
 7 010-1-1-01 DISCHARGE     
 8 010-1-1-14 ADMISSION     
 9 160-2-1-06 DISCHARGE     
10 010-3-1-01 DISCHARGE     
# ℹ 1,045 more rows</code></pre>
</div>
</div>
<p>The number of positive samples at admission is:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>(nb_positive_samples_admission <span class="ot">&lt;-</span> MALDITOF_samples <span class="sc">|&gt;</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(SampleSchedule <span class="sc">==</span> <span class="st">"ADMISSION"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">nrow</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 364</code></pre>
</div>
</div>
<p>The number of positive samples at admission is:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>(nb_positive_samples_discharge <span class="ot">&lt;-</span> MALDITOF_samples <span class="sc">|&gt;</span> </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(SampleSchedule <span class="sc">==</span> <span class="st">"DISCHARGE"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">nrow</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 691</code></pre>
</div>
</div>
<p>The number of positive samples is:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>(nb_positive_samples <span class="ot">&lt;-</span> nb_positive_samples_admission <span class="sc">+</span> nb_positive_samples_discharge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1055</code></pre>
</div>
</div>
<p>Which represents 27.02 % of samples. The distribution of bacteria across the samples:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>prevalences <span class="ot">&lt;-</span> <span class="cf">function</span>(x, nb_positive_samples, nb_samples) {</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">|&gt;</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Identification_MALDITOF) <span class="sc">|&gt;</span> </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tally</span>() <span class="sc">|&gt;</span> </span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="st">`</span><span class="at">% +ve smpls</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> n <span class="sc">/</span> nb_positive_samples, <span class="dv">1</span>),</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">% all smpls</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> n <span class="sc">/</span> nb_samples, <span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Prevalences across all samples:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>(prevalences_all <span class="ot">&lt;-</span> <span class="fu">prevalences</span>(MALDITOF, nb_positive_samples, nb_samples))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 23 × 4
   Identification_MALDITOF     n `% +ve smpls` `% all smpls`
   &lt;chr&gt;                   &lt;int&gt;         &lt;dbl&gt;         &lt;dbl&gt;
 1 Escherichia coli          827          78.4          21.2
 2 Klebsiella pneumoniae     189          17.9           4.8
 3 Enterobacter hormaechei    71           6.7           1.8
 4 unidentified               26           2.5           0.7
 5 Enterococcus faecium       25           2.4           0.6
 6 Enterobacter cloacae       24           2.3           0.6
 7 Klebsiella aerogenes       10           0.9           0.3
 8 Aeromonas caviae            7           0.7           0.2
 9 Citrobacter freundii        6           0.6           0.2
10 Enterobacter kobei          4           0.4           0.1
# ℹ 13 more rows</code></pre>
</div>
</div>
<p>The list of all the bacteria in the MALDITOF results:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>(bugs <span class="ot">&lt;-</span> prevalences_all <span class="sc">|&gt;</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(Identification_MALDITOF <span class="sc">!=</span> <span class="st">"unidentified"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">pull</span>(Identification_MALDITOF) <span class="sc">|&gt;</span> </span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">sort</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Aeromonas caviae"           "Aeromonas hydrophila"      
 [3] "Aeromonas veronii"          "Citrobacter braakii"       
 [5] "Citrobacter freundii"       "Cronobacter sp."           
 [7] "Cupriavidus gilardii"       "Enterobacter bugandensis"  
 [9] "Enterobacter cloacae"       "Enterobacter hormaechei"   
[11] "Enterobacter kobei"         "Enterobacter roggenkampii" 
[13] "Enterococcus faecium"       "Escherichia coli"          
[15] "Escherichia hermannii"      "Klebsiella aerogenes"      
[17] "Klebsiella oxytoca"         "Klebsiella pneumoniae"     
[19] "Klebsiella variicola"       "Kluyvera georgiana"        
[21] "Pseudomonas putida"         "Raoultella ornithinolytica"</code></pre>
</div>
</div>
<p>Prevalences at admission:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>(prevalences_admission <span class="ot">&lt;-</span> MALDITOF <span class="sc">|&gt;</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(SampleSchedule <span class="sc">==</span> <span class="st">"ADMISSION"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">prevalences</span>(nb_positive_samples_admission, nb_samples_admission))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 4
   Identification_MALDITOF      n `% +ve smpls` `% all smpls`
   &lt;chr&gt;                    &lt;int&gt;         &lt;dbl&gt;         &lt;dbl&gt;
 1 Escherichia coli           304          83.5          15.2
 2 Klebsiella pneumoniae       56          15.4           2.8
 3 Enterobacter hormaechei     17           4.7           0.8
 4 Enterococcus faecium         7           1.9           0.3
 5 unidentified                 5           1.4           0.2
 6 Klebsiella aerogenes         4           1.1           0.2
 7 Enterobacter cloacae         3           0.8           0.1
 8 Aeromonas caviae             2           0.5           0.1
 9 Aeromonas hydrophila         1           0.3           0  
10 Aeromonas veronii            1           0.3           0  
11 Enterobacter bugandensis     1           0.3           0  
12 Enterobacter kobei           1           0.3           0  
13 Escherichia hermannii        1           0.3           0  </code></pre>
</div>
</div>
<p>Prevalences at discharge:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>(prevalences_discharge <span class="ot">&lt;-</span> MALDITOF <span class="sc">|&gt;</span> </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(SampleSchedule <span class="sc">==</span> <span class="st">"DISCHARGE"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">prevalences</span>(nb_positive_samples_discharge, nb_samples_discharge))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 22 × 4
   Identification_MALDITOF     n `% +ve smpls` `% all smpls`
   &lt;chr&gt;                   &lt;int&gt;         &lt;dbl&gt;         &lt;dbl&gt;
 1 Escherichia coli          523          75.7          27.5
 2 Klebsiella pneumoniae     133          19.2           7  
 3 Enterobacter hormaechei    54           7.8           2.8
 4 Enterobacter cloacae       21           3             1.1
 5 unidentified               21           3             1.1
 6 Enterococcus faecium       18           2.6           0.9
 7 Citrobacter freundii        6           0.9           0.3
 8 Klebsiella aerogenes        6           0.9           0.3
 9 Aeromonas caviae            5           0.7           0.3
10 Enterobacter kobei          3           0.4           0.2
# ℹ 12 more rows</code></pre>
</div>
</div>
<p>Let’s compare the prevalences at admission and discharge:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>prev_adm_disch <span class="ot">&lt;-</span> prevalences_all <span class="sc">|&gt;</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Identification_MALDITOF) <span class="sc">|&gt;</span> </span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(prevalences_admission) <span class="sc">|&gt;</span> </span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(prevalences_discharge,</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Identification_MALDITOF"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">" (A)"</span>, <span class="st">" (D)"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">replace_na</span>(.x, <span class="dv">0</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(Identification_MALDITOF)`</code></pre>
</div>
</div>
<p>The number of positive samples:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>prev_adm_disch <span class="sc">|&gt;</span> </span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Identification_MALDITOF, <span class="fu">starts_with</span>(<span class="st">"n"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 23 × 3
   Identification_MALDITOF `n (A)` `n (D)`
   &lt;chr&gt;                     &lt;int&gt;   &lt;int&gt;
 1 Escherichia coli            304     523
 2 Klebsiella pneumoniae        56     133
 3 Enterobacter hormaechei      17      54
 4 unidentified                  5      21
 5 Enterococcus faecium          7      18
 6 Enterobacter cloacae          3      21
 7 Klebsiella aerogenes          4       6
 8 Aeromonas caviae              2       5
 9 Citrobacter freundii          0       6
10 Enterobacter kobei            1       3
# ℹ 13 more rows</code></pre>
</div>
</div>
<p>Their proportion among positive samples:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>prev_adm_disch <span class="sc">|&gt;</span> </span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Identification_MALDITOF, <span class="fu">starts_with</span>(<span class="st">"% +"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 23 × 3
   Identification_MALDITOF `% +ve smpls (A)` `% +ve smpls (D)`
   &lt;chr&gt;                               &lt;dbl&gt;             &lt;dbl&gt;
 1 Escherichia coli                     83.5              75.7
 2 Klebsiella pneumoniae                15.4              19.2
 3 Enterobacter hormaechei               4.7               7.8
 4 unidentified                          1.4               3  
 5 Enterococcus faecium                  1.9               2.6
 6 Enterobacter cloacae                  0.8               3  
 7 Klebsiella aerogenes                  1.1               0.9
 8 Aeromonas caviae                      0.5               0.7
 9 Citrobacter freundii                  0                 0.9
10 Enterobacter kobei                    0.3               0.4
# ℹ 13 more rows</code></pre>
</div>
</div>
<p>Their proportions among all samples:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>prev_adm_disch <span class="sc">|&gt;</span> </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Identification_MALDITOF, <span class="fu">starts_with</span>(<span class="st">"% a"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 23 × 3
   Identification_MALDITOF `% all smpls (A)` `% all smpls (D)`
   &lt;chr&gt;                               &lt;dbl&gt;             &lt;dbl&gt;
 1 Escherichia coli                     15.2              27.5
 2 Klebsiella pneumoniae                 2.8               7  
 3 Enterobacter hormaechei               0.8               2.8
 4 unidentified                          0.2               1.1
 5 Enterococcus faecium                  0.3               0.9
 6 Enterobacter cloacae                  0.1               1.1
 7 Klebsiella aerogenes                  0.2               0.3
 8 Aeromonas caviae                      0.1               0.3
 9 Citrobacter freundii                  0                 0.3
10 Enterobacter kobei                    0                 0.2
# ℹ 13 more rows</code></pre>
</div>
</div>
<p>The list of bacteria absent at admission and present at discharge:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>prev_adm_disch <span class="sc">|&gt;</span> </span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Identification_MALDITOF, <span class="fu">starts_with</span>(<span class="st">"n"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="st">`</span><span class="at">n (A)</span><span class="st">`</span> <span class="sc">==</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   Identification_MALDITOF    `n (A)` `n (D)`
   &lt;chr&gt;                        &lt;int&gt;   &lt;int&gt;
 1 Citrobacter freundii             0       6
 2 Raoultella ornithinolytica       0       3
 3 Kluyvera georgiana               0       2
 4 Citrobacter braakii              0       1
 5 Cronobacter sp.                  0       1
 6 Cupriavidus gilardii             0       1
 7 Enterobacter roggenkampii        0       1
 8 Klebsiella oxytoca               0       1
 9 Klebsiella variicola             0       1
10 Pseudomonas putida               0       1</code></pre>
</div>
</div>
<p>The list of bacteria present at admission and absent at discharge:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>prev_adm_disch <span class="sc">|&gt;</span> </span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Identification_MALDITOF, <span class="fu">starts_with</span>(<span class="st">"n"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="st">`</span><span class="at">n (D)</span><span class="st">`</span> <span class="sc">==</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  Identification_MALDITOF  `n (A)` `n (D)`
  &lt;chr&gt;                      &lt;int&gt;   &lt;int&gt;
1 Enterobacter bugandensis       1       0</code></pre>
</div>
</div>
<p>Let’s now look at changes in colonization status between admission and discharge. The following function prepares the data for an alluvial plot:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>make_alluvial_data <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  positive_samples <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span> </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">state =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span> <span class="co"># the exact value here does not matter</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> SampleSchedule, <span class="at">values_from =</span> state) <span class="sc">|&gt;</span> </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="sc">-</span>USUBJID, <span class="sc">~</span> <span class="sc">!</span> <span class="fu">is.na</span>(.x)))</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>  dates <span class="sc">|&gt;</span> </span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span> <span class="fu">is.na</span>(DISCHARGE)) <span class="sc">|&gt;</span> </span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(USUBJID) <span class="sc">|&gt;</span> </span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(positive_samples, <span class="st">"USUBJID"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="sc">-</span>USUBJID, <span class="sc">~</span> <span class="fu">replace_na</span>(.x, <span class="cn">FALSE</span>)),</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>           <span class="fu">across</span>(<span class="sc">-</span>USUBJID, <span class="sc">~</span> <span class="fu">c</span>(<span class="st">"cleared"</span>, <span class="st">"colonized"</span>)[<span class="fu">as.numeric</span>(.x) <span class="sc">+</span> <span class="dv">1</span>])) <span class="sc">|&gt;</span> </span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ADMISSION, DISCHARGE) <span class="sc">|&gt;</span> </span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tally</span>() <span class="sc">|&gt;</span> </span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following function is a wrapper around the above function and the the <code>alluvial2()</code> function that computes the table of changes and plot the alluvial plot for a given set of bacteria to consider:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>plot_changes <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">bacteria =</span> <span class="st">"all"</span>) {</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (bacteria <span class="sc">==</span> <span class="st">"all"</span>) {</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    the_data <span class="ot">&lt;-</span> MALDITOF_samples</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    the_data <span class="ot">&lt;-</span> MALDITOF <span class="sc">|&gt;</span> </span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>           <span class="fu">filter</span>(Identification_MALDITOF <span class="sc">%in%</span> bacteria) <span class="sc">|&gt;</span> </span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>           <span class="fu">select</span>(<span class="sc">-</span> Identification_MALDITOF)</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>  the_data <span class="sc">|&gt;</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">make_alluvial_data</span>() <span class="sc">|&gt;</span> </span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">alluvial2</span>(<span class="at">col =</span> <span class="st">"grey"</span>, <span class="at">alpha =</span> .<span class="dv">8</span>, <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s use this function to look at some example:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_changes</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  ADMISSION DISCHARGE     n
  &lt;chr&gt;     &lt;chr&gt;     &lt;int&gt;
1 cleared   cleared    1107
2 cleared   colonized   445
3 colonized cleared     106
4 colonized colonized   246</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-alluvial_all" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-alluvial_all-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analysis_files/figure-html/fig-alluvial_all-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="537">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-alluvial_all-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: The change of colonization status by any CRE between admission and discharge.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_changes</span>(<span class="st">"Escherichia coli"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  ADMISSION DISCHARGE     n
  &lt;chr&gt;     &lt;chr&gt;     &lt;int&gt;
1 cleared   cleared    1290
2 cleared   colonized   318
3 colonized cleared      91
4 colonized colonized   205</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-alluvial_Ecoli" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-alluvial_Ecoli-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analysis_files/figure-html/fig-alluvial_Ecoli-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="537">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-alluvial_Ecoli-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: The change of colonization status by <em>E. coli</em> between admission and discharge.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_changes</span>(<span class="st">"Klebsiella pneumoniae"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  ADMISSION DISCHARGE     n
  &lt;chr&gt;     &lt;chr&gt;     &lt;int&gt;
1 cleared   cleared    1739
2 cleared   colonized   110
3 colonized cleared      32
4 colonized colonized    23</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-alluvial_Kp" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-alluvial_Kp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analysis_files/figure-html/fig-alluvial_Kp-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="537">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-alluvial_Kp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: The change of colonization status by <em>K. pneumoniae</em> between admission and discharge.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="cre-exposure" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="cre-exposure"><span class="header-section-number">7</span> CRE exposure</h2>
<section id="sec-proportion_CRE" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="sec-proportion_CRE"><span class="header-section-number">7.1</span> All CRE</h3>
<p>The number of enrolled patient with CRE at admission as a function of time for each ward:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>opar <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>CRE_admission <span class="ot">&lt;-</span> MALDITOF_samples <span class="sc">|&gt;</span> </span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(SampleSchedule <span class="sc">==</span> <span class="st">"ADMISSION"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(USUBJID)</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>ward_dates <span class="sc">|&gt;</span> </span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(USUBJID <span class="sc">%in%</span> CRE_admission) <span class="sc">|&gt;</span> </span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ward) <span class="sc">|&gt;</span> </span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_map</span>(<span class="sc">~</span> <span class="fu">ward_occupancy</span>(.x), <span class="at">.keep =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">walk</span>(plot_occ, <span class="at">ann =</span> <span class="cn">FALSE</span>)</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(opar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-CREoccupancies" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-CREoccupancies-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analysis_files/figure-html/fig-CREoccupancies-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="796">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-CREoccupancies-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Number of enrolled patients with CRE at admission as a function of time for each ward.
</figcaption>
</figure>
</div>
</div>
</div>
<p>A function that plots the prevalence estimate <code>estimate</code> and lower and upper bonds <code>lower</code> and <code>upper</code> of the confidence interval from a data frame of a ward:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>plot_prevalence <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(x, <span class="fu">plot</span>(<span class="fu">x_transform</span>(date), <span class="fu">y_transform</span>(estimate),</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">ann =</span> <span class="cn">FALSE</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>))</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">|&gt;</span> </span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">duplicate_NA_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">remove_NAs</span>(estimate) <span class="sc">|&gt;</span> </span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">with</span>(.x, <span class="fu">polygon2</span>(<span class="fu">x_transform</span>(date), <span class="fu">y_transform</span>(lower), <span class="fu">y_transform</span>(upper),</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">col =</span> <span class="st">"grey"</span>)))</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(x, <span class="fu">lines</span>(<span class="fu">x_transform</span>(date), <span class="fu">y_transform</span>(estimate)))</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Computing the proportions of CRE positives as a function of time for each ward:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>numerator_df <span class="ot">&lt;-</span> ward_dates <span class="sc">|&gt;</span> </span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(USUBJID <span class="sc">%in%</span> CRE_admission) <span class="sc">|&gt;</span> </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ward) <span class="sc">|&gt;</span> </span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">ward_occupancy</span>(.x)) <span class="sc">|&gt;</span> </span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">numerator =</span> occupancy)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>proportion_CRE <span class="ot">&lt;-</span> ward_dates <span class="sc">|&gt;</span> </span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ward) <span class="sc">|&gt;</span> </span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">ward_occupancy</span>(.x)) <span class="sc">|&gt;</span> </span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">denominator =</span> occupancy) <span class="sc">|&gt;</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(numerator_df, <span class="fu">c</span>(<span class="st">"ward"</span>, <span class="st">"date"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(numerator) <span class="sc">|&gt;</span> </span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(numerator, <span class="sc">~</span> <span class="fu">replace_na</span>(.x, <span class="dv">0</span>)),</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">Clopper_Pearson =</span> <span class="fu">map2</span>(numerator, denominator, binom_test)) <span class="sc">|&gt;</span> </span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(Clopper_Pearson)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Proportion of enrolled patients that are CRE positive at admission as a function of time for each ward:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>opar <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>proportion_CRE <span class="sc">|&gt;</span> </span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ward) <span class="sc">|&gt;</span> </span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_walk</span>(<span class="sc">~</span> <span class="fu">plot_prevalence</span>(.x))</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(opar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-CREprevalences" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-CREprevalences-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analysis_files/figure-html/fig-CREprevalences-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="796">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-CREprevalences-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Proportion of enrolled patients that are CRE positive at admission as a function of time for each ward.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="k.-pneumoniae" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="k.-pneumoniae"><span class="header-section-number">7.2</span> <em>K. pneumoniae</em></h3>
<p>Here we have the same plots as for the previous section but for <em>K. pneumoniae</em> only. First the number of enrolled patient with CRE <em>K. pneumoniae</em> at admission as a function of time for each ward:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>opar <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>Kp_admission <span class="ot">&lt;-</span> MALDITOF <span class="sc">|&gt;</span> </span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(SampleSchedule <span class="sc">==</span> <span class="st">"ADMISSION"</span>,</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>         Identification_MALDITOF <span class="sc">==</span> <span class="st">"Klebsiella pneumoniae"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(USUBJID)</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>ward_dates <span class="sc">|&gt;</span> </span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(USUBJID <span class="sc">%in%</span> Kp_admission) <span class="sc">|&gt;</span> </span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ward) <span class="sc">|&gt;</span> </span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_map</span>(<span class="sc">~</span> <span class="fu">ward_occupancy</span>(.x), <span class="at">.keep =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">walk</span>(plot_occ, <span class="at">ann =</span> <span class="cn">FALSE</span>)</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(opar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Kp_occupancies" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Kp_occupancies-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analysis_files/figure-html/fig-Kp_occupancies-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="796">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Kp_occupancies-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Number of enrolled patients with CRE <em>K pneumonia</em> at admission as a function of time for each ward.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Proportion of enrolled patients that are CRE <em>K. pneumoniae</em> positive at admission as a function of time for each ward:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>numerator_df <span class="ot">&lt;-</span> ward_dates <span class="sc">|&gt;</span> </span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(USUBJID <span class="sc">%in%</span> Kp_admission) <span class="sc">|&gt;</span> </span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ward) <span class="sc">|&gt;</span> </span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">ward_occupancy</span>(.x)) <span class="sc">|&gt;</span> </span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">numerator =</span> occupancy)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>opar <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>ward_dates <span class="sc">|&gt;</span> </span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ward) <span class="sc">|&gt;</span> </span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">ward_occupancy</span>(.x)) <span class="sc">|&gt;</span> </span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">denominator =</span> occupancy) <span class="sc">|&gt;</span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(numerator_df, <span class="fu">c</span>(<span class="st">"ward"</span>, <span class="st">"date"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(numerator) <span class="sc">|&gt;</span> </span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(numerator, <span class="sc">~</span> <span class="fu">replace_na</span>(.x, <span class="dv">0</span>)),</span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">Clopper_Pearson =</span> <span class="fu">map2</span>(numerator, denominator, binom_test)) <span class="sc">|&gt;</span> </span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(Clopper_Pearson) <span class="sc">|&gt;</span> </span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ward) <span class="sc">|&gt;</span> </span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_walk</span>(<span class="sc">~</span> <span class="fu">plot_prevalence</span>(.x))</span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(opar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Kp_prevalences" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Kp_prevalences-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analysis_files/figure-html/fig-Kp_prevalences-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="796">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Kp_prevalences-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Proportion of enrolled patients that are CRE <em>K. pneumoniae</em> positive at admission as a function of time for each ward.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="data-preparation" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="data-preparation"><span class="header-section-number">8</span> Data preparation</h2>
<section id="minimum-data" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="minimum-data"><span class="header-section-number">8.1</span> Minimum data</h3>
<p>A function that generates the presence/absence data (coded as 1/2 here) from the output <code>x</code> of the MALDITOF where <code>id</code> is the column of <code>x</code> that contains the patient ID, <code>time_point</code> is the column of <code>x</code> that contains the time point of the sample (e.g. <code>ADMISSION</code> or <code>DISCHARGE</code>), <code>identification</code> is the column of <code>x</code> that contains the bacteria identified by the MALDITOF and <code>bacteria</code> is a vector of characters that contains the names of the bacteria that we want to test the presence of.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>presence_abscence <span class="ot">&lt;-</span> <span class="cf">function</span>(x, id, time_point, identification, bacteria) {</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">|&gt;</span> </span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>({{ id }}, {{ time_point }}) <span class="sc">|&gt;</span> </span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">col2listcol</span>(.x, {{ identification }})) <span class="sc">|&gt;</span> </span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">map_lgl</span>({{ identification }}, <span class="sc">~</span> <span class="fu">any</span>(bacteria <span class="sc">%in%</span> .x)) <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span> {{ identification }}) <span class="sc">|&gt;</span> </span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>({{ id }}, {{ time_point }})</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following function adds the samples that were tested negative to the output <code>x</code> of <code>presence_abscence()</code> where <code>y</code> is the samples dates as generated in <a href="#sec-samples_dates" class="quarto-xref">Section&nbsp;5.1</a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>add_negatives <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, id, time_point) {</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  tp <span class="ot">&lt;-</span> <span class="fu">as_name</span>(<span class="fu">enquo</span>(time_point))</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">|&gt;</span> </span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span> {{ id }}, <span class="at">names_to =</span> tp) <span class="sc">|&gt;</span> </span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(x, <span class="fu">c</span>(<span class="fu">as_name</span>(<span class="fu">enquo</span>(id)), tp)) <span class="sc">|&gt;</span> </span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(state, <span class="sc">~</span> <span class="fu">replace_na</span>(., <span class="dv">1</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.exclude</span>() <span class="co"># remove the absence of samples</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A function that selects patients from <code>x</code> who have samples from at least 2 time points:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>select2time_points <span class="ot">&lt;-</span> <span class="cf">function</span>(x, id) {</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  id_with_2obs <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span> </span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>({{ id }}) <span class="sc">|&gt;</span> </span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">table</span>() <span class="sc">|&gt;</span> </span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is_greater_than</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">which</span>() <span class="sc">|&gt;</span> </span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>()</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(x, {{ id }} <span class="sc">%in%</span> id_with_2obs)</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where <code>id</code> is the column of <code>x</code> that contains the patients IDs. A function that combines state and time data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>state_time <span class="ot">&lt;-</span> <span class="cf">function</span>(state, time, id, admission, discharge, time_point) {</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  time <span class="sc">|&gt;</span> </span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="st">"{{discharge}}"</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>({{ discharge }} <span class="sc">-</span> {{ admission }}) <span class="sc">/</span> mpd,</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>           <span class="st">"{{admission}}"</span> <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span> {{ id }},</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="fu">as_name</span>(<span class="fu">enquo</span>(time_point)), <span class="at">values_to =</span> <span class="st">"days"</span>) <span class="sc">|&gt;</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(<span class="at">x =</span> {{ state }}, <span class="at">y =</span> _,</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>              <span class="fu">c</span>(<span class="fu">as_name</span>(<span class="fu">enquo</span>(id)), <span class="fu">as_name</span>(<span class="fu">enquo</span>(time_point))))</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following function puts the 4 above functions together:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>msm_data <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, id, time_point, identification, bacteria,</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>                     admission, discharge) {</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">|&gt;</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">presence_abscence</span>({{ id }}, {{ time_point }}, {{ identification }}, bacteria) <span class="sc">|&gt;</span> </span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_negatives</span>(y, {{ id }}, {{ time_point }}) <span class="sc">|&gt;</span> </span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select2time_points</span>({{ id }}) <span class="sc">|&gt;</span> </span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">state_time</span>(y, {{ id }}, {{ admission }}, {{ discharge }}, {{ time_point }}) <span class="sc">|&gt;</span> </span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>({{ id }}, state, days)</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where</p>
<ul>
<li><code>x</code> is the MALDITOF data as read in section <a href="#sec-malditof_data" class="quarto-xref">Section&nbsp;6</a></li>
<li><code>y</code> is the dates of samples collections as generated from the CRF in section <a href="#sec-samples_dates" class="quarto-xref">Section&nbsp;5.1</a></li>
<li><code>id</code> is the unquoted name of the patient ID variable that should be the same in <code>x</code> and <code>y</code></li>
<li><code>time_point</code> is the unquoted name of the variable of <code>x</code> that contains the time point information (for example <code>ADMISSION</code> and <code>DISCHARGE</code>)</li>
<li><code>identification</code> is the unquoted name of the variable of <code>x</code> that contains the name of the identified bacteria</li>
<li><code>bacteria</code> is a vector of quoted names of bacteria we want to generate the data for</li>
<li><code>admission</code> is the unquoted name of the variable of <code>y</code> that contains the dates of admissions</li>
<li><code>discharge</code> is the unquoted name of the variable of <code>y</code> that contains the dates of discharge</li>
</ul>
<p>The output of this function is a data frame with 3 columns:</p>
<ul>
<li>the <code>id</code> patient ID</li>
<li>the <code>state</code> variable, with <code>1</code> and <code>2</code> for not “not infected” and “infected” respectively</li>
<li>the <code>days</code> columns where zeros refers to admissions and non-zero values are the times of discharge in days counting from admission</li>
</ul>
<p>A tuning of <code>msm_data()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>msm_data2 <span class="ot">&lt;-</span> <span class="cf">function</span>(bacteria) <span class="fu">msm_data</span>(MALDITOF, dates, USUBJID, SampleSchedule,</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>                                         Identification_MALDITOF, bacteria, ADMISSION,</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>                                         DISCHARGE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="covariates" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="covariates"><span class="header-section-number">8.2</span> Covariates</h3>
<p>The following function adds to the output <code>x</code> of the <code>msm_data()</code> function the covariate <code>otherCRE</code> that tells whether at admission the patient had a CRE other than the set of <code>bacteria</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>add_other_CRE_at_admission <span class="ot">&lt;-</span> <span class="cf">function</span>(x, bacteria) {</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  MALDITOF <span class="sc">|&gt;</span> </span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(SampleSchedule <span class="sc">==</span> <span class="st">"ADMISSION"</span>,</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>           <span class="sc">!</span> Identification_MALDITOF <span class="sc">%in%</span> bacteria) <span class="sc">|&gt;</span> </span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">otherCRE =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(USUBJID, otherCRE) <span class="sc">|&gt;</span> </span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">|&gt;</span> </span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(<span class="at">x =</span> x, <span class="at">y =</span> _, <span class="st">"USUBJID"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(otherCRE, <span class="sc">~</span> <span class="fu">replace_na</span>(.x, <span class="cn">FALSE</span>)))</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function relies on the <code>MALDITOF</code> data frame generated in section <a href="#sec-malditof_data" class="quarto-xref">Section&nbsp;6</a>. The following function adds to the output <code>x</code> of the <code>msm_data()</code> function the <code>ward</code> ID covariate:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>add_ward <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">left_join</span>(x, wards, <span class="st">"USUBJID"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function relies on the <code>wards</code> data frame generated in the section <a href="#sec-wards" class="quarto-xref">Section&nbsp;5.2</a>. The following function adds to the output <code>x</code> of the <code>add_ward()</code> function the covariates <code>estimate</code>, <code>lower</code> and <code>upper</code> that are the temporal means of the proportions of enrolled patient that are CRE positive in the ward for the duration of the study:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>add_CRE_prevalence_in_ward <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  ward_means <span class="ot">&lt;-</span> <span class="cf">function</span>(y) {</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    total_duration <span class="ot">&lt;-</span> <span class="fu">time_diff</span>(<span class="fu">range</span>(y<span class="sc">$</span>date))</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">|&gt;</span> </span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">weight =</span> <span class="fu">time_diff</span>(<span class="fu">c</span>(date, <span class="cn">NA</span>)) <span class="sc">/</span> total_duration) <span class="sc">|&gt;</span> </span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(estimate, lower, upper),</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>                       <span class="sc">~</span> <span class="fu">sum</span>(<span class="fu">replace_na</span>(.x, <span class="dv">0</span>) <span class="sc">*</span> weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>  proportion_CRE <span class="sc">|&gt;</span> </span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ward) <span class="sc">|&gt;</span> </span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">ward_means</span>(.x)) <span class="sc">|&gt;</span> </span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(<span class="at">x =</span> x, <span class="at">y =</span> _, <span class="st">"ward"</span>)</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function relies on the <code>proportion_CRE</code> data frame generated in the section <a href="#sec-proportion_CRE" class="quarto-xref">Section&nbsp;7.1</a>.</p>
</section>
</section>
<section id="k.-pneumoniae-1" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="k.-pneumoniae-1"><span class="header-section-number">9</span> <em>K. pneumoniae</em></h2>
<section id="preparing-the-data" class="level3" data-number="9.1">
<h3 data-number="9.1" class="anchored" data-anchor-id="preparing-the-data"><span class="header-section-number">9.1</span> Preparing the data</h3>
<p>Generating the presence/absence of <em>K. pneumoniae</em>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>K_pneumoniae_raw <span class="ot">&lt;-</span> <span class="fu">presence_abscence</span>(MALDITOF, USUBJID, SampleSchedule,</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>                                      Identification_MALDITOF, <span class="st">"Klebsiella pneumoniae"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Which gives:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>K_pneumoniae_raw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,055 × 3
   USUBJID     SampleSchedule state
   &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
 1 008-1-1-05  ADMISSION          1
 2 008-1-1-05  DISCHARGE          2
 3 008-1-1-07  ADMISSION          1
 4 008-1-1-07  DISCHARGE          1
 5 008-1-1-08  ADMISSION          1
 6 008-1-1-08  DISCHARGE          1
 7 008-1-1-100 DISCHARGE          1
 8 008-1-1-14  ADMISSION          1
 9 008-1-1-14  DISCHARGE          1
10 008-1-1-15  DISCHARGE          1
# ℹ 1,045 more rows</code></pre>
</div>
</div>
<p>Where <code>1</code> is absence and <code>2</code> is presence. Adding the samples with negative culture:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>(K_pneumoniae_raw_a <span class="ot">&lt;-</span> <span class="fu">add_negatives</span>(K_pneumoniae_raw, dates, USUBJID, SampleSchedule))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,904 × 4
   USUBJID    SampleSchedule value               state
   &lt;chr&gt;      &lt;chr&gt;          &lt;dttm&gt;              &lt;dbl&gt;
 1 008-1-1-01 ADMISSION      2025-03-11 16:30:00     1
 2 008-1-1-01 DISCHARGE      2025-03-13 14:40:00     1
 3 008-1-1-02 ADMISSION      2025-03-12 10:00:00     1
 4 008-1-1-02 DISCHARGE      2025-03-14 10:00:00     1
 5 008-1-1-03 ADMISSION      2025-03-12 09:50:00     1
 6 008-1-1-03 DISCHARGE      2025-03-14 09:50:00     1
 7 008-1-1-04 ADMISSION      2025-03-12 13:45:00     1
 8 008-1-1-04 DISCHARGE      2025-03-13 14:55:00     1
 9 008-1-1-05 ADMISSION      2025-03-12 13:40:00     1
10 008-1-1-05 DISCHARGE      2025-03-28 17:00:00     2
# ℹ 3,894 more rows</code></pre>
</div>
</div>
<p>Selecting the patients that have samples from at least 2 time points:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>(K_pneumoniae <span class="ot">&lt;-</span> <span class="fu">select2time_points</span>(K_pneumoniae_raw_a, USUBJID))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,808 × 4
   USUBJID    SampleSchedule value               state
   &lt;chr&gt;      &lt;chr&gt;          &lt;dttm&gt;              &lt;dbl&gt;
 1 008-1-1-01 ADMISSION      2025-03-11 16:30:00     1
 2 008-1-1-01 DISCHARGE      2025-03-13 14:40:00     1
 3 008-1-1-02 ADMISSION      2025-03-12 10:00:00     1
 4 008-1-1-02 DISCHARGE      2025-03-14 10:00:00     1
 5 008-1-1-03 ADMISSION      2025-03-12 09:50:00     1
 6 008-1-1-03 DISCHARGE      2025-03-14 09:50:00     1
 7 008-1-1-04 ADMISSION      2025-03-12 13:45:00     1
 8 008-1-1-04 DISCHARGE      2025-03-13 14:55:00     1
 9 008-1-1-05 ADMISSION      2025-03-12 13:40:00     1
10 008-1-1-05 DISCHARGE      2025-03-28 17:00:00     2
# ℹ 3,798 more rows</code></pre>
</div>
</div>
<p>Making the dataset for the multistate modelling:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>(Kp_msm <span class="ot">&lt;-</span> <span class="fu">state_time</span>(K_pneumoniae, dates, USUBJID,</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>                      ADMISSION, DISCHARGE, SampleSchedule))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,808 × 5
   USUBJID    SampleSchedule value               state  days
   &lt;chr&gt;      &lt;chr&gt;          &lt;dttm&gt;              &lt;dbl&gt; &lt;dbl&gt;
 1 008-1-1-01 ADMISSION      2025-03-11 16:30:00     1  0   
 2 008-1-1-01 DISCHARGE      2025-03-13 14:40:00     1  1.92
 3 008-1-1-02 ADMISSION      2025-03-12 10:00:00     1  0   
 4 008-1-1-02 DISCHARGE      2025-03-14 10:00:00     1  2   
 5 008-1-1-03 ADMISSION      2025-03-12 09:50:00     1  0   
 6 008-1-1-03 DISCHARGE      2025-03-14 09:50:00     1  2   
 7 008-1-1-04 ADMISSION      2025-03-12 13:45:00     1  0   
 8 008-1-1-04 DISCHARGE      2025-03-13 14:55:00     1  1.05
 9 008-1-1-05 ADMISSION      2025-03-12 13:40:00     1  0   
10 008-1-1-05 DISCHARGE      2025-03-28 17:00:00     2 16.1 
# ℹ 3,798 more rows</code></pre>
</div>
</div>
<p>Alternatively, we can do all at once with this function:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>Kp_msm <span class="ot">&lt;-</span> <span class="fu">msm_data</span>(MALDITOF, dates, USUBJID, SampleSchedule, Identification_MALDITOF,</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Klebsiella pneumoniae"</span>, ADMISSION, DISCHARGE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which gives:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>Kp_msm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,808 × 3
   USUBJID    state  days
   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;
 1 008-1-1-01     1  0   
 2 008-1-1-01     1  1.92
 3 008-1-1-02     1  0   
 4 008-1-1-02     1  2   
 5 008-1-1-03     1  0   
 6 008-1-1-03     1  2   
 7 008-1-1-04     1  0   
 8 008-1-1-04     1  1.05
 9 008-1-1-05     1  0   
10 008-1-1-05     2 16.1 
# ℹ 3,798 more rows</code></pre>
</div>
</div>
<p>Or, even simpler here:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>Kp_msm <span class="ot">&lt;-</span> <span class="fu">msm_data2</span>(<span class="st">"Klebsiella pneumoniae"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Adding covariates:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>(Kp_msm_cov <span class="ot">&lt;-</span> Kp_msm <span class="sc">|&gt;</span> </span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">add_other_CRE_at_admission</span>(<span class="st">"Klebsiella pneumoniae"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">add_ward</span>() <span class="sc">|&gt;</span> </span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">add_CRE_prevalence_in_ward</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,808 × 8
   USUBJID    state  days otherCRE ward   estimate  lower upper
   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;    &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 008-1-1-01     1  0    FALSE    008100    0.231 0.0757 0.538
 2 008-1-1-01     1  1.92 FALSE    008100    0.231 0.0757 0.538
 3 008-1-1-02     1  0    FALSE    008100    0.231 0.0757 0.538
 4 008-1-1-02     1  2    FALSE    008100    0.231 0.0757 0.538
 5 008-1-1-03     1  0    FALSE    008100    0.231 0.0757 0.538
 6 008-1-1-03     1  2    FALSE    008100    0.231 0.0757 0.538
 7 008-1-1-04     1  0    FALSE    008100    0.231 0.0757 0.538
 8 008-1-1-04     1  1.05 FALSE    008100    0.231 0.0757 0.538
 9 008-1-1-05     1  0    TRUE     008100    0.231 0.0757 0.538
10 008-1-1-05     2 16.1  TRUE     008100    0.231 0.0757 0.538
# ℹ 3,798 more rows</code></pre>
</div>
</div>
</section>
<section id="multi-state-modelling" class="level3" data-number="9.2">
<h3 data-number="9.2" class="anchored" data-anchor-id="multi-state-modelling"><span class="header-section-number">9.2</span> Multi-state modelling</h3>
<section id="basic-operations" class="level4" data-number="9.2.1">
<h4 data-number="9.2.1" class="anchored" data-anchor-id="basic-operations"><span class="header-section-number">9.2.1</span> Basic operations</h4>
<p>Defining the structure of the <span class="math inline">\(Q\)</span> matrix:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>Q <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>           <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Initial values of the <span class="math inline">\(Q\)</span> matrix:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>(Q_crude <span class="ot">&lt;-</span> <span class="fu">crudeinits.msm</span>(state <span class="sc">~</span> days, USUBJID, Q, Kp_msm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]       [,2]
[1,] -0.0113743  0.0113743
[2,]  0.0845829 -0.0845829</code></pre>
</div>
</div>
<p>Fitting a simple model without any covariate:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>(Kp_msm_fit <span class="ot">&lt;-</span> <span class="fu">msm</span>(state <span class="sc">~</span> days, USUBJID, Kp_msm, Q))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
msm(formula = state ~ days, subject = USUBJID, data = Kp_msm,     qmatrix = Q)

Maximum likelihood estimates

Transition intensities
                  Baseline                   
State 1 - State 1 -0.0198 (-0.02570,-0.01526)
State 1 - State 2  0.0198 ( 0.01526, 0.02570)
State 2 - State 1  0.1622 ( 0.10926, 0.24078)
State 2 - State 2 -0.1622 (-0.24078,-0.10926)

-2 * log-likelihood:  891.3579 </code></pre>
</div>
</div>
<p>Or we call simply do:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>(Kp_msm_fit <span class="ot">&lt;-</span> <span class="fu">bsm</span>(state <span class="sc">~</span> days, USUBJID, Kp_msm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
bsm(formula = state ~ days, subject = USUBJID, data = Kp_msm)

Maximum likelihood estimates

Transition intensities
                  Baseline                   
State 1 - State 1 -0.0198 (-0.02570,-0.01526)
State 1 - State 2  0.0198 ( 0.01526, 0.02570)
State 2 - State 1  0.1622 ( 0.10926, 0.24078)
State 2 - State 2 -0.1622 (-0.24078,-0.10926)

-2 * log-likelihood:  891.3579 </code></pre>
</div>
</div>
<p>Estimated transition intensity <span class="math inline">\(Q\)</span> matrix:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qmatrix.msm</span>(Kp_msm_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        State 1                     State 2                    
State 1 -0.0198 (-0.02570,-0.01526)  0.0198 ( 0.01526, 0.02570)
State 2  0.1622 ( 0.10926, 0.24078) -0.1622 (-0.24078,-0.10926)</code></pre>
</div>
</div>
<p>Estimated transition probability <span class="math inline">\(P\)</span> matrix per day:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pmatrix.msm</span>(Kp_msm_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          State 1    State 2
State 1 0.9818947 0.01810533
State 2 0.1482932 0.85170679</code></pre>
</div>
</div>
<p>Estimated mean sojourn times in each transient state:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sojourn.msm</span>(Kp_msm_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        estimates       SE         L         U
State 1 50.497744 6.716332 38.909885 65.536616
State 2  6.165342 1.242748  4.153178  9.152376</code></pre>
</div>
</div>
<p>Log-likelihood of the model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(Kp_msm_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' -445.6789 (df=2)</code></pre>
</div>
</div>
</section>
<section id="bootstrapped-cis" class="level4" data-number="9.2.2">
<h4 data-number="9.2.2" class="anchored" data-anchor-id="bootstrapped-cis"><span class="header-section-number">9.2.2</span> Bootstrapped CIs</h4>
<p>Bootstrapping <span class="math inline">\(Q\)</span> estimates (1000 samples, takes 42” in parallel on 11 cores):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>q_list <span class="ot">&lt;-</span> <span class="fu">boot.msm</span>(Kp_msm_fit, <span class="cf">function</span>(x) <span class="fu">qmatrix.msm</span>(x)<span class="sc">$</span>estimates, <span class="dv">1000</span>,</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">cores =</span> nb_cores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Reformating the output into an array of dimension 2, 2, and 1000 (i.e.&nbsp;2 states and 1000 bootstrap samples):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>q_array <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="fu">unlist</span>(q_list), <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or we can simply do this instead of the above two successive command lines:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>q_array <span class="ot">&lt;-</span> <span class="fu">boot_msm</span>(Kp_msm_fit, qmatrix.msm, <span class="dv">1000</span>, <span class="at">cores =</span> nb_cores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The bootstrap estimate of the standard deviation:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(q_array, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, sd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            [,1]        [,2]
[1,] 0.002915611 0.002915611
[2,] 0.038059276 0.038059276</code></pre>
</div>
</div>
<p>Or, equivalently, in a formatted output:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boot_stat</span>(q_array)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            State 1     State 2
State 1 0.002915611 0.002915611
State 2 0.038059276 0.038059276</code></pre>
</div>
</div>
<p>And with the mean:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boot_stat</span>(q_array, mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            State 1     State 2
State 1 -0.02001547  0.02001547
State 2  0.16552718 -0.16552718</code></pre>
</div>
</div>
<p>Or the median:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boot_stat</span>(q_array, median)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            State 1     State 2
State 1 -0.01980986  0.01980986
State 2  0.16110287 -0.16110287</code></pre>
</div>
</div>
<p>The bootstrap estimate of the 95% confidence interval:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>q_array <span class="sc">|&gt;</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aperm</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>, , 1

             [,1]       [,2]
2.5%  -0.02636783 0.01495202
97.5% -0.01495202 0.02636783

, , 2

           [,1]       [,2]
2.5%  0.1045769 -0.2530344
97.5% 0.2530344 -0.1045769</code></pre>
</div>
</div>
<p>Or, equivalently, in a formatted output:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boot_ci</span>(q_array)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>, , State 1

          State 1    State 2
2.5%  -0.02636783 0.01495202
97.5% -0.01495202 0.02636783

, , State 2

        State 1    State 2
2.5%  0.1045769 -0.2530344
97.5% 0.2530344 -0.1045769</code></pre>
</div>
</div>
</section>
<section id="covariates-1" class="level4" data-number="9.2.3">
<h4 data-number="9.2.3" class="anchored" data-anchor-id="covariates-1"><span class="header-section-number">9.2.3</span> Covariates</h4>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>(Kp_msm_cov_fit <span class="ot">&lt;-</span> <span class="fu">bsm</span>(state <span class="sc">~</span> days, USUBJID, Kp_msm_cov,</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">covariates =</span> <span class="fu">list</span>(<span class="st">"1-2"</span> <span class="ot">=</span> <span class="er">~</span> otherCRE)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
bsm(formula = state ~ days, subject = USUBJID, data = Kp_msm_cov,     covariates = list(`1-2` = ~otherCRE))

Maximum likelihood estimates
Baselines are with covariates set to their means

Transition intensities with hazard ratios for each covariate
                  Baseline                     otherCRETRUE        
State 1 - State 1 -0.01978 (-0.02568,-0.01524)                     
State 1 - State 2  0.01978 ( 0.01524, 0.02568) 0.967 (0.5744,1.628)
State 2 - State 1  0.16192 ( 0.10903, 0.24045) 1.000               
State 2 - State 2 -0.16192 (-0.24045,-0.10903)                     

-2 * log-likelihood:  891.3417 </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qmatrix.msm</span>(Kp_msm_cov_fit, <span class="at">covariates=</span><span class="fu">list</span>(<span class="at">otherCRE =</span> <span class="cn">FALSE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        State 1                      State 2                     
State 1 -0.01989 (-0.02604,-0.01519)  0.01989 ( 0.01519, 0.02604)
State 2  0.16192 ( 0.10903, 0.24045) -0.16192 (-0.24045,-0.10903)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qmatrix.msm</span>(Kp_msm_cov_fit, <span class="at">covariates=</span><span class="fu">list</span>(<span class="at">otherCRE =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        State 1                      State 2                     
State 1 -0.01989 (-0.02604,-0.01519)  0.01989 ( 0.01519, 0.02604)
State 2  0.16192 ( 0.10903, 0.24045) -0.16192 (-0.24045,-0.10903)</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>(Kp_msm_cov_fit <span class="ot">&lt;-</span> <span class="fu">bsm</span>(state <span class="sc">~</span> days, USUBJID, Kp_msm_cov,</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">covariates =</span> <span class="fu">list</span>(<span class="st">"1-2"</span> <span class="ot">=</span> <span class="er">~</span> estimate)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
bsm(formula = state ~ days, subject = USUBJID, data = Kp_msm_cov,     covariates = list(`1-2` = ~estimate))

Maximum likelihood estimates
Baselines are with covariates set to their means

Transition intensities with hazard ratios for each covariate
                  Baseline                     estimate            
State 1 - State 1 -0.01991 (-0.02588,-0.01531)                     
State 1 - State 2  0.01991 ( 0.01531, 0.02588) 1.731 (0.2013,14.88)
State 2 - State 1  0.16327 ( 0.10974, 0.24292) 1.000               
State 2 - State 2 -0.16327 (-0.24292,-0.10974)                     

-2 * log-likelihood:  891.1111 </code></pre>
</div>
</div>
</section>
<section id="diagnostics" class="level4" data-number="9.2.4">
<h4 data-number="9.2.4" class="anchored" data-anchor-id="diagnostics"><span class="header-section-number">9.2.4</span> Diagnostics</h4>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.prevalence.msm</span>(Kp_msm_fit, <span class="at">mintime =</span> <span class="dv">0</span>, <span class="at">maxtime =</span> <span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="analysis_files/figure-html/unnamed-chunk-113-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="537"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="pipeline" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="pipeline"><span class="header-section-number">10</span> Pipeline</h2>
<p>A first pipeline without any covariate:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>pipeline1 <span class="ot">&lt;-</span> <span class="cf">function</span>(bacteria) {</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (bacteria <span class="sc">==</span> <span class="st">"all"</span>) bacteria <span class="ot">&lt;-</span> bugs</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>  bacteria <span class="sc">|&gt;</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">msm_data2</span>() <span class="sc">|&gt;</span> </span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bsm</span>(state <span class="sc">~</span> days, USUBJID, <span class="at">data =</span> _) <span class="sc">|&gt;</span> </span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bsm_estimations</span>() <span class="sc">|&gt;</span> </span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="dv">2</span>)</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s estimate the colonization and clearance rates for several different sets of bacteria:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>bacteria_sets <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"all"</span>, <span class="st">"Escherichia coli"</span>, <span class="st">"Klebsiella pneumoniae"</span>,</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Enterobacter hormaechei"</span>)</span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>bacteria_sets <span class="sc">|&gt;</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(pipeline1) <span class="sc">|&gt;</span> </span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(bacteria_sets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$all
             estimate lower upper
colonization    10.11  8.85 11.54
clearance       10.46  8.37 13.09

$`Escherichia coli`
             estimate lower upper
colonization     6.16  5.36  7.08
clearance        9.21  7.33 11.58

$`Klebsiella pneumoniae`
             estimate lower upper
colonization     1.98  1.53  2.57
clearance       16.22 10.93 24.08

$`Enterobacter hormaechei`
             estimate lower  upper
colonization     2.43  0.87   6.82
clearance       78.39 25.74 238.77</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>